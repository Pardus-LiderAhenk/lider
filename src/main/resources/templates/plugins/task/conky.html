<!DOCTYPE html>

<html lang="tr" class="app-ui" xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">
<head>
<meta charset="UTF-8">
<title>Insert title here</title>
</head>
<body>
<h6 th:text="${pluginTask.description}"> </h6> 
<h6>  deneme</h6> 
<hr>


<span th:text="${pluginTask.description}"> </span> 
<span id="entrySize"> </span> 

<hr>
<div class="login-form-1">
				<div class="login-group">
					<div class="form-group">
					Mesaj : 
						<input type="text" class="form-control" id="username" name="param" >
						
						<div id="plugin-result">result</div>
					</div>
				</div>
				
</div>
<script type="text/javascript">
				
				var ref=connection.addHandler(conkylistener, null, 'message', null, null,  null); 
				
				var dnlist=[]
				
				for (var i = 0; i < selectedEntries.length; i++) {
					dnlist.push(selectedEntries[i].distinguishedName);
				}
				
// 				var data = {
// 						"pluginName":"conky",
// 						"dnList":dnlist,
// 						"pluginVersion":"1.0.0",
// 						"timestamp":1523430976357,
// 						"dnType":"AHENK",
// 						"parameterMap":{"conkyMessage":"DENEEM","removeConkyMessage":false},
// 						"commandId":"EXECUTE_CONKY"
// 				}
				
				selectedPluginTask.dnList=dnlist;
				selectedPluginTask.parameterMap={};
				selectedPluginTask.entryList=selectedEntries;
				selectedPluginTask.dnType="AHENK";
				
				var params = JSON.stringify(selectedPluginTask); 

				$("#gonder").click(function(e) {
				    e.preventDefault();
				    
				    $.ajax({
				      type: "POST",
				      url: "/lider/task/execute",
				       headers: {
				          'Content-Type':'application/json',
				      }, 
				      data: params,
				      contentType: "application/json",
				      dataType: "json",
				      converters: {
				        'text json': true
				      }, 
				      success: function(result) {
				    	  
				    	var res = jQuery.parseJSON(result);
				    	console.log("rest response")
				    	console.log(res)
						if(res.status=="OK"){
				    		$("#plugin-result").html("Görev başarı ile gönderildi.. Cevap Bekleniyor..");
				    	}
				      },
				      error: function(result) {
				        alert(result);
				      }
				    });
				  }); 
				
				function conkylistener(msg) {
				    var to = msg.getAttribute('to');
				    var from = msg.getAttribute('from');
				    var type = msg.getAttribute('type');
				    var elems = msg.getElementsByTagName('body');
				    
				    if (type == "chat" && elems.length > 0) {
					
				    	var body = elems[0];
				    	var data=Strophe.xmlunescape(Strophe.getText(body));
				    	var xmppResponse=JSON.parse(data);
						if(xmppResponse.commandClsId == "EXECUTE_CONKY"){
							$("#plugin-result").html(xmppResponse.result.responseMessage);
						}
						/* connection.deleteHandler(ref); */
				    }
				    // we must return true to keep the handler alive. returning false would remove it after it finishes.
				    return true;
				}
				$('#closePage').click(function(e){
					connection.deleteHandler(ref);
				});
	</script>

</body>
</html>